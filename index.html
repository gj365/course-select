<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>选课时间表（数据库关联）</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
    }
    table {
      border-collapse: collapse;
      margin-top: 20px;
      width: 100%;
      max-width: 900px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background: #f4f4f4;
    }
    td.slot {
      cursor: pointer;
      background: #e8f5e9;
    }
    td.full {
      background: #f8d7da;
      color: #888;
      cursor: not-allowed;
    }
    td.break {
      background: #f0e68c;
      color: #888;
      pointer-events: none;
    }
  </style>
</head>
<body>

<h2>选课时间表（剩余名额）</h2>

<table id="schedule">
  <thead>
    <tr>
      <th>时间</th>
      <th>3/31</th>
      <th>4/1</th>
      <th>4/2</th>
      <th>4/3</th>
      <th>4/4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>9:00 - 9:30</td>
      <td class="slot" data-time="9:00 - 9:30" data-date="3/31">2</td>
      <td class="slot" data-time="9:00 - 9:30" data-date="4/1">2</td>
      <td class="slot" data-time="9:00 - 9:30" data-date="4/2">2</td>
      <td class="slot" data-time="9:00 - 9:30" data-date="4/3">2</td>
      <td class="slot" data-time="9:00 - 9:30" data-date="4/4">2</td>
    </tr>
    <!-- 更多时间段 -->
  </tbody>
</table>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  // 创建 Supabase 客户端
  const SUPABASE_URL = "https://iodijnhbxihastuknqky.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvZGlqbmhieGloYXN0dWtucWt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4NjgyNTIsImV4cCI6MjA4NTQ0NDI1Mn0.PTG1s0Zv14VX-yfrZNmJqyu-R7wlvJl3_YYcq40g6Y4";
  
  const supabaseClient = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

  // 从数据库获取课程名额数据并更新页面
  async function loadSchedule() {
    const slots = document.querySelectorAll(".slot");

    for (let cell of slots) {
      const time = cell.getAttribute("data-time");
      const date = cell.getAttribute("data-date");

      const { count, error } = await supabaseClient
        .from("enrollments")
        .select("*", { count: "exact" })
        .eq("time_slot", time)
        .eq("date", date);

      if (error) {
        console.error("查询出错：", error.message);
      } else {
        console.log("查询结果：", count);  // 查看查询结果
      }

      // 默认剩余名额为2
      let remaining = 2;

      // 如果有记录，计算剩余名额
      if (count > 0) {
        remaining = 2 - count;
      }

      // 更新页面显示剩余名额，作为链接
      const link = document.createElement("a");
      link.href = `enroll.html?time=${time}&date=${date}`;
      link.textContent = remaining;
      
      cell.textContent = ''; // 清空单元格
      cell.appendChild(link); // 插入链接

      // 如果名额已满，禁用该时间段
      if (remaining === 0) {
        cell.classList.add("full");
        cell.classList.remove("slot");
        link.style.pointerEvents = "none";  // 禁用点击
      }
    }
  }

  // 加载课程数据
  loadSchedule();
</script>

</body>
</html>
